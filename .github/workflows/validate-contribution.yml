name: ğŸ¤– ValidaciÃ³n y Auto-merge de Contribuciones

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'contributors-data.js'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.fork == true
    
    steps:
    - name: ğŸ” Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”„ Checkout main branch
      run: |
        git checkout main
        git pull origin main

    - name: ğŸŒ¿ Checkout PR branch
      run: |
        git checkout ${{ github.event.pull_request.head.sha }}

    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“ Validate contributors-data.js
      id: validate
      run: |
        echo "ğŸ” Iniciando validaciÃ³n de contribuciÃ³n..."
        
        # Verificar que solo se modificÃ³ contributors-data.js
        CHANGED_FILES=$(git diff --name-only main...HEAD)
        echo "Archivos modificados: $CHANGED_FILES"
        
        if [[ "$CHANGED_FILES" != "contributors-data.js" ]]; then
          echo "âŒ Error: Solo se permite modificar contributors-data.js"
          echo "Archivos modificados: $CHANGED_FILES"
          echo "validation_result=failed" >> $GITHUB_OUTPUT
          echo "error_message=Solo se permite modificar contributors-data.js. Archivos modificados: $CHANGED_FILES" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Validar sintaxis JavaScript
        echo "ğŸ” Validando sintaxis JavaScript..."
        if ! node -c contributors-data.js; then
          echo "âŒ Error de sintaxis JavaScript"
          echo "validation_result=failed" >> $GITHUB_OUTPUT
          echo "error_message=Error de sintaxis en contributors-data.js. Por favor revisa la estructura del archivo." >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Crear script de validaciÃ³n
        cat > validate_contribution.js << 'EOF'
        const fs = require('fs');
        
        try {
          // Leer y evaluar el archivo
          const fileContent = fs.readFileSync('contributors-data.js', 'utf8');
          const contributors = eval(fileContent.replace('const contributors = ', '').replace(/;$/, ''));
          
          if (!Array.isArray(contributors)) {
            throw new Error('contributors debe ser un array');
          }
          
          console.log(`ğŸ“Š Total de contribuidores: ${contributors.length}`);
          
          // Obtener solo el Ãºltimo contribuidor (la nueva contribuciÃ³n)
          const newContributor = contributors[contributors.length - 1];
          
          if (!newContributor) {
            throw new Error('No se encontrÃ³ ningÃºn contribuidor nuevo');
          }
          
          console.log(`ğŸ” Validando contribuidor: ${newContributor.nickname || 'Sin nickname'}`);
          
          const errors = [];
          
          // Validar campos requeridos
          const requiredFields = ['name', 'nickname', 'github', 'description', 'hobbies'];
          for (const field of requiredFields) {
            if (!newContributor[field] || newContributor[field] === '') {
              errors.push(`âŒ Campo requerido faltante: ${field}`);
            }
          }
          
          // Validar nickname formato
          if (newContributor.nickname && !/^[a-zA-Z0-9-_]+$/.test(newContributor.nickname)) {
            errors.push('âŒ Nickname solo puede contener letras, nÃºmeros, guiones y guiones bajos');
          }
          
          // Validar URLs
          if (newContributor.github && !newContributor.github.startsWith('https://github.com/')) {
            errors.push('âŒ URL de GitHub debe comenzar con https://github.com/');
          }
          
          if (newContributor.linkedin && !newContributor.linkedin.match(/^https:\/\/(www\.)?linkedin\.com\/(in|pub)\/[\w-]+\/?$/)) {
            errors.push('âŒ URL de LinkedIn invÃ¡lida. Formato: https://linkedin.com/in/username');
          }
          
          if (newContributor.instagram && !newContributor.instagram.match(/^https:\/\/(www\.)?instagram\.com\/[\w.-]+\/?$/)) {
            errors.push('âŒ URL de Instagram invÃ¡lida. Formato: https://instagram.com/username');
          }
          
          // Validar descripciÃ³n
          if (newContributor.description && newContributor.description.length > 150) {
            errors.push(`âŒ DescripciÃ³n muy larga: ${newContributor.description.length} caracteres (mÃ¡ximo 150)`);
          }
          
          // Validar hobbies
          if (!Array.isArray(newContributor.hobbies)) {
            errors.push('âŒ hobbies debe ser un array');
          } else if (newContributor.hobbies.length > 4) {
            errors.push(`âŒ MÃ¡ximo 4 hobbies permitidos, encontrados: ${newContributor.hobbies.length}`);
          }
          
          // Validar duplicados (solo en los contribuidores anteriores)
          const existingContributors = contributors.slice(0, -1);
          const duplicateNickname = existingContributors.find(c => c.nickname === newContributor.nickname);
          if (duplicateNickname) {
            errors.push(`âŒ Nickname '${newContributor.nickname}' ya existe`);
          }
          
          if (errors.length > 0) {
            console.error('ğŸš¨ Errores de validaciÃ³n encontrados:');
            errors.forEach(error => console.error(error));
            process.exit(1);
          }
          
          console.log('âœ… ValidaciÃ³n exitosa!');
          console.log(`ğŸ‘¤ Contribuidor: ${newContributor.name} (@${newContributor.nickname})`);
          
        } catch (error) {
          console.error('âŒ Error durante la validaciÃ³n:', error.message);
          process.exit(1);
        }
        EOF
        
        # Ejecutar validaciÃ³n
        if node validate_contribution.js; then
          echo "validation_result=success" >> $GITHUB_OUTPUT
        else
          echo "validation_result=failed" >> $GITHUB_OUTPUT
          echo "error_message=FallÃ³ la validaciÃ³n de datos del contribuidor" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ğŸ”„ Auto-resolve conflicts and merge
      if: steps.validate.outputs.validation_result == 'success'
      run: |
        echo "ğŸš€ Iniciando proceso de auto-merge..."
        
        # Configurar git
        git config user.name "XperienceCampus Bot"
        git config user.email "action@github.com"
        
        # Ir a main y hacer pull para obtener Ãºltimos cambios
        git checkout main
        git pull origin main
        
        # Crear una rama temporal para el merge
        TEMP_BRANCH="auto-merge-${{ github.event.pull_request.number }}-$(date +%s)"
        git checkout -b $TEMP_BRANCH
        
        # Intentar hacer merge de la PR
        if git merge ${{ github.event.pull_request.head.sha }} --no-edit; then
          echo "âœ… Merge exitoso sin conflictos"
        else
          echo "ğŸ”§ Detectado conflicto, resolviendo automÃ¡ticamente..."
          
          # Resolver conflicto en contributors-data.js
          if [[ -f contributors-data.js ]]; then
            # Obtener la contribuciÃ³n de la PR
            git checkout ${{ github.event.pull_request.head.sha }} -- contributors-data.js
            
            # Leer la nueva contribuciÃ³n
            NEW_CONTRIBUTOR=$(node -e "
              const fs = require('fs');
              const content = fs.readFileSync('contributors-data.js', 'utf8');
              const contributors = eval(content.replace('const contributors = ', '').replace(/;$/, ''));
              const newContrib = contributors[contributors.length - 1];
              console.log(JSON.stringify(newContrib, null, 2));
            ")
            
            # Obtener la versiÃ³n actual de main
            git checkout main -- contributors-data.js
            
            # Agregar la nueva contribuciÃ³n al final
            node -e "
              const fs = require('fs');
              let content = fs.readFileSync('contributors-data.js', 'utf8');
              const newContrib = $NEW_CONTRIBUTOR;
              
              // Remover el ]; final
              content = content.replace(/\];?\s*$/, '');
              
              // Agregar la nueva contribuciÃ³n
              const contributorStr = ',\\n  ' + JSON.stringify(newContrib, null, 2).replace(/\\n/g, '\\n  ');
              content += contributorStr + '\\n];';
              
              fs.writeFileSync('contributors-data.js', content);
            "
            
            # Validar que la sintaxis sigue siendo correcta
            if node -c contributors-data.js; then
              git add contributors-data.js
              git commit -m "ğŸ¤– Auto-resolve: Add contributor ${{ github.event.pull_request.user.login }}"
              echo "âœ… Conflicto resuelto automÃ¡ticamente"
            else
              echo "âŒ Error al resolver conflicto automÃ¡ticamente"
              exit 1
            fi
          fi
        fi
        
        # Push de la rama temporal
        git push origin $TEMP_BRANCH
        
        # Merge a main
        git checkout main
        git merge $TEMP_BRANCH --no-edit
        git push origin main
        
        # Limpiar rama temporal
        git push origin --delete $TEMP_BRANCH
        
        echo "ğŸ‰ ContribuciÃ³n mergeada exitosamente!"

    - name: âœ… Success Comment
      if: steps.validate.outputs.validation_result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: `ğŸ‰ **Â¡ContribuciÃ³n exitosa!**
            
            âœ… **Validaciones pasadas:**
            - ğŸ“ Sintaxis JavaScript correcta
            - ğŸ·ï¸ Todos los campos requeridos presentes
            - ğŸ”— URLs vÃ¡lidas
            - ğŸ¯ LÃ­mite de hobbies respetado (â‰¤4)
            - ğŸ“ DescripciÃ³n dentro del lÃ­mite (â‰¤150 caracteres)
            - ğŸš« Nickname Ãºnico
            - ğŸ”¤ Formato de nickname vÃ¡lido
            
            ğŸš€ **Tu perfil ha sido agregado automÃ¡ticamente y estarÃ¡ visible en la pÃ¡gina web en unos minutos.**
            
            Â¡Gracias por contribuir al proyecto! ğŸŒŸ
            
            ---
            *ğŸ¤– Mensaje automÃ¡tico del sistema de validaciÃ³n*`
          });
          
          // Cerrar el PR como merged
          await github.rest.pulls.update({
            owner,
            repo,
            pull_number: number,
            state: 'closed'
          });

    - name: âŒ Failure Comment
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const errorMessage = process.env.ERROR_MESSAGE || 'Error desconocido durante la validaciÃ³n';
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: `ğŸš¨ **ValidaciÃ³n fallida**
            
            **Error encontrado:**
            ${errorMessage}
            
            ğŸ“‹ **Para corregir:**
            1. Revisa el error especÃ­fico arriba
            2. Haz los cambios necesarios en tu rama
            3. Haz commit y push - el PR se actualizarÃ¡ automÃ¡ticamente
            4. La validaciÃ³n se ejecutarÃ¡ nuevamente
            
            ğŸ“š **Recursos de ayuda:**
            - [GuÃ­a completa con Codespace](https://github.com/${owner}/${repo}/blob/main/pages/como-contribuir-codespace.html)
            - [Plantilla de contribuciÃ³n](https://github.com/${owner}/${repo}#-plantilla-de-datos)
            - [Errores comunes y soluciones](https://github.com/${owner}/${repo}#-errores-frecuentes-y-soluciones)
            
            ---
            *ğŸ¤– Mensaje automÃ¡tico del sistema de validaciÃ³n*`
          });
      env:
        ERROR_MESSAGE: ${{ steps.validate.outputs.error_message }}